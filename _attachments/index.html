<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>ShutterStem</title>
        <style>
            html {
                width: 100%; height: 100%;
            }
            body {
                background: black; color: white;
                padding: 0px; margin: 0px; width: 100%; height: 100%;
                display: -webkit-box; -webkit-box-align: stretch;
            }
            #baskets {
                max-height: 95%;
                width: 125px;
                border: 1px dashed red; padding: 20px;
                overflow: auto;
            }
            #thumbnails {
                max-height: 95%;
                -webkit-box-flex: 1.0;
                overflow: auto;
            }
            .frame {
                width: 256px; height: 256px; margin: 32px 8px; float: left;
                display: -webkit-box; -webkit-box-align: center; -webkit-box-pack: center;
            }
            .image { max-width: 256px; max-height: 256px; border: 6px solid white; }
            .selected { border: 6px solid blue; }
            
            .basket { clear: both; margin: 1em 0em; }
            .basket h1 { margin: 0.1em; font-size: 100%; }
            .basket ul { margin: 0em; padding: 0em; }
            .basket li { margin: 0em 0.25em; cursor: pointer; text-decoration: underline; }
            .basket.displayed .add { display: none; }
            .basket .remove { display: none; }
            .basket.displayed .remove { display: block; }
        </style>
        <script src="couch.js"></script>
        <script src="flatstache.js"></script>
        <script src="classlist.js"></script>
        <script id="basket_template" type="text/x-flat">
            <section id="{{ id }}" class="basket">
                <!-- menu/commands? -->
                <h1>{{ value }}</h1>
                <ul>
                    <li class="view">View
                    <li class="rename">Rename
                    <li class="add">Add selection
                    <li class="remove">Remove selection
                </ul>
            </section>
        </script>
        <script id="thumbnail_template" type="text/x-flat">
            <div class="frame"><img class="image" id="{{id}}" src="{{doc_url}}/thumbnail/512.jpg"></div>
        </script>
    </head>
    
    <body>
        <div id="baskets">
            <a href id="add_basket">Add basket</a>
        </div>
        <div id="thumbnails"></div>
        
        <script>
            var db = new Couch("http://stravinsky.local:5984/dev");
            
            var thumbnails = document.getElementById('thumbnails');
            var selection = {};
            db.get("_design/shutterstem/_view/by_date", {descending:true, reduce:false, limit:25}, function (response) {
                response.rows.forEach(function (imageRow) {
                    imageRow.doc_url = db.urlFor(imageRow.id);
                    var frame = Flatstache.elementify('thumbnail_template', imageRow);
                    var image = frame.querySelector(".image");
                    if (!image.classList) {
                        image.classList = new ClassList(image);
                    }
                    image.addEventListener("click", function () {
                        var selected = this.classList.toggle("selected");
                        if (selected) {
                            selection[this.id] = true;
                        } else {
                            delete selection[this.id];
                        }
                    }, false);
                    thumbnails.appendChild(frame);
                });
            });
            
            
            var baskets = document.getElementById('baskets');
            db.get("_design/shutterstem/_view/baskets", {descending:true}, function (response) {
                response.rows.forEach(function (basketRow) {
                    var basket = Flatstache.elementify('basket_template', basketRow);
                    baskets.appendChild(basket);
                });
            });
            document.getElementById('add_basket').addEventListener('click', function (e) {
                e.preventDefault();
                
                var basketId = "testbasket-" + Math.random();
                var basket = {
                    "testtype-basket": true,
                    name: "New basket",
                    photos: Object.keys(selection),
                    created: (new Date).toISOString()
                };
                
                db.http("PUT", basket, basketId, null, function (status, response) {
                    var b = Flatstache.elementify('basket_template', {id:basketId, value:basket.name});
                    baskets.insertBefore(b, document.getElementById('add_basket').nextSibling);
                });
            }, false);
        </script>
    </body>
</html>