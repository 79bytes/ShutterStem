<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>ShutterStem</title>
        <style>
            html {
                width: 100%; height: 100%;
            }
            body {
                background: black; color: white;
                padding: 0px; margin: 0px; width: 100%; height: 100%;
                display: -webkit-box; -webkit-box-align: stretch;
            }
            #debug {
                border: 1px dashed red;
            }
            #baskets {
                max-height: 95%;
                width: 125px;  padding: 20px;
                overflow: auto;
            }
            #thumbnails {
                max-height: 95%;
                -webkit-box-flex: 1.0;
                overflow: auto;
            }
            .frame {
                width: 256px; height: 256px; margin: 32px 8px; float: left;
                display: -webkit-box; -webkit-box-align: center; -webkit-box-pack: center;
            }
            .image { max-width: 256px; max-height: 256px; border: 6px solid white; cursor: pointer; }
            .selected { border: 6px solid blue; }
            
            .basket { clear: both; margin: 1em 0em; }
            .basket h1 { margin: 0.1em; font-size: 110%; font-weight: normal; cursor: pointer; }
            .basket.displayed h1 { font-weight: bold; color: blue; }
            .basket ul { margin: 0em; padding: 0em; }
            .basket li, #add_basket { margin: 0em 0.25em; }
            .basket.displayed .add { display: none; }
            .basket .remove { display: none; }
            .basket.displayed .remove { display: list-item; }
            .clickable { cursor: pointer; text-decoration: underline; }
            .subtly_clickable { cursor: pointer; }
        </style>
        <script src="couch.js"></script>
        <script src="flatstache.js"></script>
        <script src="classlist.js"></script>
        <script id="basket_template" type="text/x-flat">
            <section id="{{ id }}" class="basket">
                <!-- menu/commands? -->
                <h1 class="subtly_clickable">{{ value }}</h1>
                <ul>
                    <li class="rename clickable">Rename
                    <li class="add clickable">Add selection
                    <li class="remove clickable">Remove selection
                </ul>
            </section>
        </script>
        <script id="thumbnail_template" type="text/x-flat">
            <div class="frame"><img class="image" id="{{id}}" src="{{doc_url}}/thumbnail/512.jpg"></div>
        </script>
    </head>
    
    <body>
        <div id="baskets">
            <span id="add_basket" class="clickable">Add basket</a>
        </div>
        <div id="thumbnails"></div>
        
        <script>
            var db = new Couch();
            var selection = {};
            
            var thumbnails = document.getElementById('thumbnails');
            function addThumbnail(imageRow) {
                imageRow.id || (imageRow.id = imageRow._id);
                imageRow.doc_url = db.urlFor(imageRow.id);
                var frame = Flatstache.elementify('thumbnail_template', imageRow);
                var image = frame.querySelector(".image");
                if (!image.classList) {
                    image.classList = new ClassList(image);
                }
                image.addEventListener("click", function () {
                    var selected = this.classList.toggle("selected");
                    if (selected) {
                        selection[this.id] = true;
                    } else {
                        delete selection[this.id];
                    }
                }, false);
                thumbnails.appendChild(frame);
            }
            
            var lastShow;
            function showPhotos(prev, start, options) {
                lastShow = {prev:prev, start:start, options:options};
                thumbnails.innerHTML = "";
                if (start) {
                    var to_prev = document.createElement("div");
                    to_prev.className = "frame subtly_clickable";
                    to_prev.innerText = "← Previous";
                    to_prev.addEventListener("click", function () {
                        showPhotos(prev && prev.prev, prev, {count:options.count, show_last:true});
                    }, false);
                    thumbnails.appendChild(to_prev);
                } else {
                    var to_import = document.createElement("a");
                    to_import.href = "dashboard.html";
                    to_import.target = "DashboardWindow";
                    to_import.className = "frame";
                    to_import.innerText = "Import more...";
                    thumbnails.appendChild(to_import);
                }
                
                var query = {descending:true, reduce:false, limit:options.count+1};
                if (start) {
                    query.$startkey = start.key;
                    query.startkey_docid = start.id;
                }
                db.get("_design/shutterstem/_view/by_date", query, function (response) {
                    var nextRow;
                    if (response.total_rows - response.offset - options.count > 0) {
                        nextRow = response.rows.pop();
                    }
                    response.rows.forEach(addThumbnail);
                    
                    if (options.show_last) {
                        thumbnails.scrollTop = thumbnails.scrollHeight - thumbnails.clientHeight;
                    }
                    
                    if (!nextRow) {
                        return;
                    }
                    var to_next = document.createElement("div");
                    to_next.className = "frame subtly_clickable";
                    to_next.innerText = "Next →";
                    to_next.addEventListener("click", function () {
                        if (start && prev) {
                            start.prev = prev;
                        }
                        showPhotos(start, nextRow, {count:options.count});
                    }, false);
                    thumbnails.appendChild(to_next);
                });
            
            }
            showPhotos(null, null, {count:25});
            
            var baskets = document.getElementById('baskets');
            function addBasket(basketRow, i) {
                var basket = Flatstache.elementify('basket_template', basketRow);
                if (!basket.classList) {
                    basket.classList = new ClassList(basket);
                }
                
                basket.querySelector("h1").addEventListener("click", function () {
                    var currentBasket = baskets.querySelector(".displayed");
                    if (currentBasket && currentBasket !== basket) {
                        currentBasket.classList.remove("displayed");
                    }
                    var displayed = basket.classList.toggle("displayed");
                    thumbnails.innerHTML = "";
                    selection = {};
                    if (displayed) {
                        db.get(basketRow.id, null, function (doc) {
                            doc.photos.forEach(addThumbnail);
                        });
                    } else {
                        showPhotos(lastShow.prev, lastShow.start, lastShow.options);
                        db.get("_design/shutterstem/_view/by_date", {descending:true, reduce:false, limit:25}, function (response) {
                            response.rows.forEach(addThumbnail);
                        });
                    }
                }, false);
                
                basket.querySelector(".rename").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    var newName = prompt("Name this basket:", basketDoc.name);
                    if (!newName) {
                        return;
                    }
                    basketDoc.name = newName;
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    basket.querySelector("h1").innerText = newName;
                    baskets.insertBefore(basket, document.getElementById('add_basket').nextElementSibling);
                }, false);
                
                basket.querySelector(".add").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    var currentPhotos = {};
                    basketDoc.photos.forEach(function (photo) { currentPhotos[photo._id] = true; });
                    Object.keys(selection).forEach(function (photoId) {
                        if (photoId in currentPhotos) {
                            return;
                        }
                        var image = document.getElementById(photoId);
                        image.classList.remove("selected");
                        basketDoc.photos.push(Couch.makeRef({_id:photoId}));
                    });
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    baskets.insertBefore(basket, document.getElementById('add_basket').nextElementSibling);
                    selection = {};
                }, false);
                
                basket.querySelector(".remove").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    basketDoc.photos = basketDoc.photos.filter(function (photo) {
                        if (!selection[photo._id]) {
                            return true;
                        }
                        var frame = document.getElementById(photo._id).parentNode;
                        frame.parentNode.removeChild(frame);
                        return false;
                    });
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    baskets.insertBefore(basket, document.getElementById('add_basket').nextElementSibling);
                    selection = {};
                }, false);
                
                if (i !== 'top') {
                    baskets.appendChild(basket);
                } else {
                    baskets.insertBefore(basket, document.getElementById('add_basket').nextElementSibling);
                }
            }
            db.get("_design/shutterstem/_view/baskets", {descending:true}, function (response) {
                response.rows.forEach(addBasket);
            });
            document.getElementById('add_basket').addEventListener('click', function (e) {
                var basket = {
                    _id: "testbasket-" + Math.random(),
                    "testtype-basket": true,
                    name: "Basket",
                    photos: Object.keys(selection).map(function (id) { return Couch.makeRef({_id:id}); }),
                    created: (new Date).toISOString()
                };
                db.write(basket);
                addBasket({id:basket._id, value:basket.name}, 'top');
            }, false);
        </script>
    </body>
</html>