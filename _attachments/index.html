<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>ShutterStem</title>
        <style>
            html {
                width: 100%; height: 100%;
            }
            body {
                background: black; color: white;
                padding: 0px; margin: 0px; width: 100%; height: 100%;
                display: -webkit-box; -webkit-box-align: stretch;
            }
            #debug {
                border: 1px dashed red;
            }
            #baskets {
                max-height: 95%;
                width: 135px;  padding: 20px;
                overflow: auto;
            }
            #thumbnails {
                max-height: 95%;
                -webkit-box-flex: 1.0;
                overflow: auto;
            }
            .frame {
                width: 256px; height: 256px; margin: 32px 8px; float: left;
                display: -webkit-box; -webkit-box-align: center; -webkit-box-pack: center;
                -webkit-transition: -webkit-transform 0.15s linear 0.1s;
            }
            .image {
                max-width: 256px; max-height: 256px; border: 6px solid white;
                cursor: pointer; -webkit-touch-callout: none;
            }
            .selected { border: 6px solid blue; }
            
            .frame.enlarged { -webkit-transform: scale(2); -moz-transform: scale(2); }
            
            .basket { clear: both; margin: 1em 0em; color: grey; }
            #_selection_basket { color: lightgray; }
            .basket.displayed { color: white; }
            .basket h1 { margin: 0.1em; font-size: 110%; font-weight: normal; }
            #_selection_basket h1 { font-style: italic; color: blue; }
            .basket.displayed h1 { font-weight: bold; }
            
            .basket ul { margin: 0em; padding: 0em; }
            .basket li { margin: 0em 0.25em; }
            .basket.displayed .add { display: none; }
            .basket .remove { display: none; }
            .basket.displayed .remove { display: list-item; }
            .clickable { cursor: pointer; text-decoration: underline; }
            .subtly_clickable { cursor: pointer; }
        </style>
        <script src="couch.js"></script>
        <script src="flatstache.js"></script>
        <script src="classlist.js"></script>
        <script id="basket_template" type="text/x-flat">
            <section id="{{ id }}" class="basket">
                <!-- menu/commands? -->
                <h1 class="subtly_clickable">{{ value }}</h1>
                <ul>
                    <li class="rename clickable">Rename
                    <li class="download clickable">Download
                    <li class="add clickable">Add selection
                    <li class="remove clickable">Remove selection
                    <li class="delete clickable">Delete basket
                </ul>
            </section>
        </script>
        <script id="thumbnail_template" type="text/x-flat">
            <div class="frame"><img class="image" id="{{id}}" src="{{doc_url}}/thumbnail/512.jpg"></div>
        </script>
    </head>
    
    <body>
        <div id="baskets">
            <section id="_selection_basket" class="basket">
            <h1 id="selection">Selection</h1>
            <ul>
                <li class="create clickable">Save as basket
                <li class="download clickable">Download
                <li class="all clickable">Select all 
                <li class="clear clickable">Clear
            </ul>
        </div>
        <div id="thumbnails"></div>
        
        <script>
            var db = new Couch();
            
            function selectedPhotos(returnType) {
                var result = document.querySelectorAll('.image.selected');
                if (returnType === '[]') {
                    result = Array.prototype.map.call(result, function (img) {
                        return img.id;
                    });
                } else if (returnType === '{}') {
                    var dict = {};
                    Array.prototype.forEach.call(result, function (img) {
                        dict[img.id] = true;
                    });
                    result = dict;
                }
                return result;
            }
            
            var thumbnails = document.getElementById('thumbnails');
            function addThumbnail(imageRow) {
                imageRow.id || (imageRow.id = imageRow._id);
                imageRow.doc_url = db.urlFor(imageRow.id);
                var frame = Flatstache.elementify('thumbnail_template', imageRow);
                if (!frame.classList) {
                    frame.classList = new ClassList(frame);
                }
                var image = frame.querySelector(".image");
                if (!image.classList) {
                    image.classList = new ClassList(image);
                }
                
                image.addEventListener("mousedown", function (e) {
                    image.classList.toggle("selected");
                    frame.classList.add("enlarged");
                }, false);
                image.addEventListener("mouseup", function () {
                    frame.classList.remove("enlarged");
                }, false);
                
                thumbnails.appendChild(frame);
            }
            
            function showPhotos(prev, start, options) {
                localStorage['shutterstem-lastShow'] = JSON.stringify({prev:prev, start:start, options:options});
                thumbnails.innerHTML = "";
                if (start) {
                    var to_prev = document.createElement("div");
                    to_prev.className = "frame subtly_clickable";
                    to_prev.innerText = "← Previous";
                    to_prev.addEventListener("click", function () {
                        showPhotos(prev && prev.prev, prev, {count:options.count, show_last:true});
                    }, false);
                    thumbnails.appendChild(to_prev);
                } else {
                    var to_import = document.createElement("div");
                    to_import.className = "frame";
                    to_import.innerHTML="<a href='dashboard.html' target='DashboardWindow'>Import more...</a>";
                    thumbnails.appendChild(to_import);
                }
                
                var query = {descending:true, reduce:false, limit:options.count+1};
                if (start) {
                    query.$startkey = start.key;
                    query.startkey_docid = start.id;
                }
                db.get("_design/shutterstem/_view/by_date", query, function (response) {
                    var nextRow;
                    if (response.total_rows - response.offset - options.count > 0) {
                        nextRow = response.rows.pop();
                    }
                    response.rows.forEach(addThumbnail);
                    
                    if (options.show_last) {
                        thumbnails.scrollTop = thumbnails.scrollHeight - thumbnails.clientHeight;
                    }
                    
                    if (!nextRow) {
                        return;
                    }
                    var to_next = document.createElement("div");
                    to_next.className = "frame subtly_clickable";
                    to_next.innerText = "Next →";
                    to_next.addEventListener("click", function () {
                        if (start && prev) {
                            start.prev = prev;
                        }
                        showPhotos(start, nextRow, {count:options.count});
                    }, false);
                    thumbnails.appendChild(to_next);
                });
            
            }
            function showLastPhotos() {
                var lastShow;
                try {
                    lastShow = JSON.parse(localStorage['shutterstem-lastShow']);
                } catch (e) {}
                if (lastShow) {
                    delete lastShow.options.show_last;
                    showPhotos(lastShow.prev, lastShow.start, lastShow.options);
                } else {
                    showPhotos(null, null, {count:25});
                }
            }
            showLastPhotos();
            
            var baskets = document.getElementById('baskets');
            function addBasket(basketRow, i) {
                var basket = Flatstache.elementify('basket_template', basketRow);
                if (!basket.classList) {
                    basket.classList = new ClassList(basket);
                }
                
                basket.querySelector("h1").addEventListener("click", function () {
                    var currentBasket = baskets.querySelector(".displayed");
                    if (currentBasket && currentBasket !== basket) {
                        currentBasket.classList.remove("displayed");
                    }
                    var displayed = basket.classList.toggle("displayed");
                    thumbnails.innerHTML = "";
                    if (displayed) {
                        db.get(basketRow.id, null, function (doc) {
                            doc.photos.forEach(addThumbnail);
                        });
                    } else {
                        showLastPhotos();
                    }
                }, false);
                
                basket.querySelector(".rename").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    var newName = prompt("Name this basket:", basketDoc.name);
                    if (!newName) {
                        return;
                    }
                    basketDoc.name = newName;
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    basket.querySelector("h1").innerText = newName;
                    baskets.insertBefore(basket, document.getElementById('_selection_basket').nextElementSibling);
                }, false);
                
                basket.querySelector(".add").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    var currentPhotos = {};
                    basketDoc.photos.forEach(function (photo) { currentPhotos[photo._id] = true; });
                    selectedPhotos('[]').forEach(function (photoId) {
                        if (photoId in currentPhotos) {
                            return;
                        }
                        var image = document.getElementById(photoId);
                        image.classList.remove("selected");
                        basketDoc.photos.push(Couch.makeRef({_id:photoId}));
                    });
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    baskets.insertBefore(basket, document.getElementById('_selection_basket').nextElementSibling);
                }, false);
                
                basket.querySelector(".remove").addEventListener("click", function () {
                    var selected = selectedPhotos('{}');
                    var basketDoc = db.read(basketRow.id);
                    basketDoc.photos = basketDoc.photos.filter(function (photo) {
                        if (selected[photo._id]) {
                            var frame = document.getElementById(photo._id).parentNode;
                            frame.parentNode.removeChild(frame);
                            return false;
                        } else {
                            return true;
                        }
                    });
                    basketDoc.modified = (new Date).toISOString();
                    db.write(basketDoc);
                    baskets.insertBefore(basket, document.getElementById('_selection_basket').nextElementSibling);
                }, false);
                
                basket.querySelector(".delete").addEventListener("click", function () {
                    var basketDoc = db.read(basketRow.id);
                    var forReals = confirm("\"" + basketDoc.name + "\" will disappear forever.");
                    if (!forReals) {
                        return;
                    }
                    db.remove(basketDoc);
                    if (basket.classList.contains("displayed")) {
                        showLastPhotos();
                    }
                    basket.parentNode.removeChild(basket);
                }, false);
                
                if (i !== 'top') {
                    baskets.appendChild(basket);
                } else {
                    baskets.insertBefore(basket, document.getElementById('_selection_basket').nextElementSibling);
                }
            }
            db.get("_design/shutterstem/_view/baskets", {descending:true}, function (response) {
                response.rows.forEach(addBasket);
            });
            document.querySelector('#_selection_basket .create').addEventListener('click', function (e) {
                var name = prompt("Create a basket named:", "Untitled Basket");
                if (!name) {
                    return;
                }
                var photos = selectedPhotos('[]').map(function (id) {
                    var image = document.getElementById(id);
                    image.classList.remove("selected");
                    return Couch.makeRef({_id:id});
                });
                var basket = {
                    _id: "testbasket-" + Math.random(),
                    "testtype-basket": true,
                    name: name,
                    photos: photos,
                    created: (new Date).toISOString()
                };
                db.write(basket);
                addBasket({id:basket._id, value:basket.name}, 'top');
            }, false);
            document.querySelector('#_selection_basket .all').addEventListener('click', function (e) {
                Array.prototype.forEach.call(document.querySelectorAll('.image'), function (img) {
                    img.classList.add("selected");
                });
            });
            document.querySelector('#_selection_basket .clear').addEventListener('click', function (e) {
                Array.prototype.forEach.call(document.querySelectorAll('.image'), function (img) {
                    img.classList.remove("selected");
                });
            });
        </script>
    </body>
</html>