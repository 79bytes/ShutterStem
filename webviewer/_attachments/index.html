<!DOCTYPE html>
<html>
  <head>
    <title>ShutterStem webviewer</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
  </head>
  <body>
    <div id="account"></div>

    <h1>ShutterStem webviewer</h1>
    
    <h2>Recent photos <img id="sparkline"/></h2>
    <div id="thumbnails">(Loading 25 recent photos)</div>
    <p style="clear:both"><a href="_list/thumbnails/by_date?reduce=false&limit=150&descending=true">see all...</a></p>
  </body>
  <script src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8">
    var gApp;
    $.couch.app(function(app) {
      $("#account").evently("account", app);
      
      gApp = app;
      function renderThumbnails(response) {
        var list;
        
        // TODO: links to image view
        list = $.mustache("<ul>{{#photos}}<li>{{>thumbnail}}</li>{{/photos}}</ul>",
                          {photos:response.rows},
                          {thumbnail: "<a href='_show/photo_info/{{id}}'><img src='" + app.db.uri + "{{id}}/small.jpg'/></a>"});
        $("#thumbnails").attr('innerHTML', list);
      }
      //app.view("by_date?reduce=false&descending=true&limit=25", {success: renderThumbnails});
      app.view("by_date?reduce=false&descending=true&limit=25", {success: renderThumbnails});
      
      var level = 0;
      var limit = 150;
      function renderChart(response) {
        //console.log("Got", response.rows.length, "rows for level", level);
        if (response.rows.length < limit && level < 6) {
          // retrigger until we get lots of data points
          level += 1;
          app.view("by_date?descending=true&group=true&group_level=" + level, {success: renderChart});
          return;
        }
        
        var countData, startD, timeData, requestString;
        chartData = response.rows.slice(0, limit).map(function (row, i) {
          return row.value;
        });
        startD = null;
        timeData = response.rows.slice(0, limit).map(function (row) {
          var d = row.key;
          d = new Date(d[0], (d[1]-1)||0, d[2]||0, d[3]||0, d[4]||0, d[5]||0);
          d = d.valueOf() / 1000;
          if (!startD) {
            startD = d;
          }
          return startD - d;
        });
        // TODO: also remove Internet/Skynet dependency. likely to be a bit more code, though!
        requestString = ("&chd=t:" + timeData.join() +"|"+ chartData.join() +
                         "&chds=" + [0, timeData[timeData.length-1], 0, Math.max.apply(Math, chartData)].join());
        $("#sparkline").attr('src', "http://chart.apis.google.com/chart?cht=lxy:nda&chs=500x30" + requestString);
      }
      renderChart({rows:[]});
    });
  </script>
</html>
