<!doctype html>
<html>
    <head>
    <meta charset="UTF-8">
    <title>ShutterStem - Export</title>
    
    <style>
        #config { display: none; }
        
        h2 { margin-bottom: 0.1em; }
        #start { display: block; margin-top: 1em; font-size: 150%; color: gray; }
        #start[href] { color: green; }
        
        #thumbnails { max-width: 500px; }
        .thumbnail { margin: 4px; }
        
        #progress { display: none; }
        #stop, #undo { visibility: hidden; }
        #stop[href], #undo[href] { visibility: visible; }
        
        #log li.error { color: red; }
        #log li.success { color: green; }
    </style>
    <script src="{{ database_url }}/_design/shutterstem/couch.js"></script>
    <script src="{{ database_url }}/_design/shutterstem/flatstache.js"></script>
    {{=<% %>=}}
    <script id="logitem_template" type="text/x-flat">
        <li class="{{ status }}">{{ msg }}</li>
    </script>
    <%={{ }}=%>
    </head>
    
    <body>
        <h1>ShutterStem Export</h1>
        
        <section id="preview">
            <form>
            <h2>Format:</h2>
            <label><input type="radio" name="export_format" value="original">Copy original files</label><br>
            <label><input type="radio" name="export_format" value="2048">Huge size (2048 pixels)</label><br>
            <label><input type="radio" name="export_format" value="1024" checked>Large size (1024 pixels)</label><br>
            <label><input type="radio" name="export_format" value="640">Medium size (640 pixels)</label><br>
            <h2>Location:</h2>
            Photos will be exported into <var class="export_path">the folder this utility is within</var>.<br>
            <label><input name="in_folder" type="checkbox" checked>Put inside subfolder</label>
            <label>named: <input name="folder_name" type="text" value="{{ default_subfolder_name }}"></label><br>
            
            <h2 id="thumbnails_caption">Preview:</h2>
            <div id="thumbnails">Loading...</div>
            <a id="start">Begin export</a>
            </form>
        </section>
        
        <section id="progress">
            <h2>Exporting:</h2>
            <span id="log_summary"></span> <a id="stop">Stop</a> <a id="undo">Undo</a>
            <ul id="log"></ul>
        </section>
        
        <div id="config"
            data-database_url="{{ database_url }}"
            data-utility_path="{{ utility_path }}"
            data-csrf_token="{{ csrf_token }}"></div>
        <script>
            var config = document.getElementById('config');
            var database_url = config.getAttribute('data-database_url');
            var csrf_token = config.getAttribute('data-csrf_token');
            var utility_path = config.getAttribute('data-utility_path');
            var db = new Couch(database_url);
            
            var format;
            Array.prototype.forEach.call(document.getElementsByName("export_format"), function (button) {
                if (button.checked) {
                    format = button.value;
                }
                button.addEventListener("change", function () {
                    format = this.value;
                }, false);
            });
            
            var folder, subfolder, full_path;
            function updatePath() {
                full_path = (subfolder) ? [folder, subfolder].join('/') : folder;
                Array.prototype.forEach.call(document.querySelectorAll('.export_path'), function (el) {
                    el.textContent = full_path;
                });
            }
            var folder_name = document.getElementsByName("folder_name")[0];
            folder_name.addEventListener("input", function () {
                subfolder = folder_name.value;
                updatePath();
            }, false);
            document.getElementsByName("in_folder")[0].addEventListener("change", function () {
                if (this.checked) {
                    folder_name.disabled = false;
                    subfolder = folder_name.value;
                } else {
                    folder_name.disabled = true;
                    subfolder = null;
                }
                updatePath();
            }, false);
            folder = utility_path.split("/").slice(0, -1).join("/");
            subfolder = folder_name.value;
            updatePath();
            
            var images;
            var thumbnails = document.getElementById("thumbnails");
            window.addEventListener("message", function (e) {
                if (e.source === window.parent) {
                    thumbnails.innerHTML = "";
                    // fake URL for user to see in status bar
                    start.href = db.urlFor(['_local_shutterstem', 'export'], {images:e.data});
                    images = e.data.split(",");
                    function addImage(imageId) {
                        var img = new Image();
                        img.className = "thumbnail";
                        img.src = db.urlFor([imageId, "thumbnail/64.jpg"]);
                        thumbnails.appendChild(img);
                    }
                    var LIMIT = 5;
                    if (images.length > LIMIT + 2) {
                        images.slice(0, LIMIT).forEach(addImage);
                            var more = document.createElement("a");
                            more.href = "#";
                            more.textContent = "See all " + images.length + " images..."
                            more.addEventListener("click", function (e) {
                                e.preventDefault();
                                thumbnails.removeChild(more);
                                images.slice(LIMIT).forEach(addImage);
                            }, false);
                            thumbnails.appendChild(more);
                    } else {
                        images.forEach(addImage);
                    }
                }
            }, false);
            
            var start = document.getElementById("start");
            var stop = document.getElementById("stop");
            var undo = document.getElementById("undo");
            
            var export_id;
            start.addEventListener("click", function (e) {
                e.preventDefault();
                if (!this.href) {
                    return;
                } else {
                    this.href = null;
                }
                
                var info = {folder:full_path, images:images, format:format};
                var query = {token:csrf_token, utility:utility_path};
                db.http("POST", info, ['_local_shutterstem', 'export', 'start'], query, function (status, response) {
                    if (status == 201) {
                        export_id = response.id;
                        showProgress();
                    }
                });
            }, false);
            
            stop.addEventListener("click", cancelExport, false);
            undo.addEventListener("click", cancelExport, false);
            function cancelExport(e) {
                e.preventDefault();
                if (!this.href) {
                    return;
                } else {
                    this.href = null;
                }
                
                var query = {token:csrf_token, utility:utility_path};
                if (this === stop) {
                    query['keep'] = true;
                } else {
                    stop.href = null;
                }
                db.http("POST", null, ['_local_shutterstem', 'export', export_id, 'cancel'], query, function (status, response) {
                    if (status === 202) {
                        this.href = null;
                    }
                });
            }
            
            var log_position = 0, log_size = 50;
            var log = document.getElementById('log');
            var log_summary = document.getElementById('log_summary');
            function showProgress() {
                document.getElementById("preview").style.display = "none";
                document.getElementById("progress").style.display = "block";
                
                db.get(['_local_shutterstem', 'export', export_id], {log_skip:log_position, log_limit:log_size}, function (status) {
                    var description = "Export....yeah.";
                    log_summary.textContent = description;
                    
                    if (!status.done) {
                        stop.href = db.urlFor(['_local_shutterstem', 'export', export_id, 'cancel'], {'keep':true});
                    } else {
                        stop.href = null;
                    }
                    if (!status.cancelled) {
                        undo.href = db.urlFor(['_local_shutterstem', 'export', export_id, 'cancel']);
                    } else {
                        undo.href = null;
                    }
                    
                    status.log.forEach(function (item) {
                        item.status = (item.ok) ? "success" : "error";
                        log.appendChild(Flatstache.elementify('logitem_template', item));
                    });
                    log_position += status.log.length;
                    if (!status.done || (status.cancelled && status.exported)) {
                        setTimeout(showProgress, (status.log.length < log_size) ? 1500 : 0);
                    }
                    
                    if (status.done) {
                        window.onunload = function () {
                            var query = {token:csrf_token, utility:utility_path};
                            db.http("POST", null, ['_local_shutterstem', 'export', export_id, 'finish'], query);
                       };
                    }
                });
            }
            
        </script>
    </body>
</html>