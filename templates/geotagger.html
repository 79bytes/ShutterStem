<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>ShutterStem Geotagger</title>
    <!--
    <script src="d3.min.js"></script>
    <script src="d3.geo.min.js"></script>
    <script src="fermata.min.js"></script>
    <script src="polymaps.min.js"></script>
    -->
    
    <script src="../_attachments/d3.min.js"></script>
    <script src="../_attachments/d3.geo.min.js"></script>
    <script src="../_attachments/fermata.min.js"></script>
    <script src="../_attachments/polymaps.min.js"></script>
    
    <style>
        #map { width: 100%; height: 450px; }
        #timeline { width: 100%; height: 75px; border: 1px solid gray; }
        #thumbnails { width: 100%; margin: 5px 0; padding: 0; list-style: none; white-space: nowrap; overflow: auto; }
        #thumbnails li { display: inline; margin: 4px; }
        svg .photo { fill: gray; }
        svg .coord { fill: blue; }
    </style>
</head>
<body>
    <div id="controls">
        <label>Timezone <input id="timezone" type="range" min="-12" max="12" step="1" value="0"></label>
        <label id="tz_val" for="timezone">0h</label> : <label id="aj_val" for="adjuster">0m</label>
        <label><input id="adjuster" type="range" min="-30" max="30" value="0" disabled> Adjustment</label>
    </div>
    <div id="map"></div>
    <svg id="timeline"></svg>
    <ol id="thumbnails"></ol>
    
    <script id="setup" data-photo_db="http://localhost:5984/photos" data-location_db="http://localhost:5984/loctest" data-photo_rows="{{ photo_rows }}"></script>
    <script>
        // stub to facilitate quicker local iteration
        var req = new XMLHttpRequest();
        req.open('GET', "http://localhost:5984/photos/_design/shutterstem-t3/_view/by_date?reduce=false&startkey=[2007,7,1]&limit=500", false);
        req.send();
        d3.select("#setup").attr('data-photo_query', req.response);
    </script>
    
    <script>
        var setupEl = d3.select("#setup"),
            photo_query = JSON.parse(setupEl.attr('data-photo_query')),
            photo_db = setupEl.attr('data-photo_db')
            location_db = setupEl.attr('data-location_db');
        
        function dateAsArrayUTC(date) {
            date instanceof Date || (date = new Date(date));
            return [
                date.getUTCFullYear(),      // 0
                date.getUTCMonth() + 1,     // 1
                date.getUTCDate(),          // 2
                date.getUTCHours(),         // 3
                date.getUTCMinutes(),       // 4
                date.getUTCSeconds() + (date.getUTCMilliseconds() / 1000)
            ];
        }
        function dateFromArrayUTC(arr) {
            var d = new Date();
            d.setUTCFullYear(arr[0] || 0);
            d.setUTCMonth(arr[1] - 1 || 0);
            d.setUTCDate(arr[2] || 1);
            d.setUTCHours(arr[3] || 0);
            d.setUTCMinutes(arr[4] || 0);
            d.setUTCSeconds(Math.floor(arr[5]) || 0);
            d.setUTCMilliseconds(1000 * (arr[5] - Math.floor(arr[5])) || 0);
            return d;
        }
        
        var photoDB = fermata.json(photo_db),
            photos = photo_query.rows.map(function (r) { return {id:r.id, key:r.key, time:dateFromArrayUTC(r.key).getTime()}; });
        
        var thumbnails = d3.select("#thumbnails").selectAll('.photo').data(photos);
        thumbnails.enter().append('li').append('img').attr('src', function (d) { return photoDB(d.id)(["thumbnail/64.jpg"])(); });
        
        var MAX_ADJUSTMENT = 1.5 * 60 * 60 * 1000,
            minTime = photos[0].time - MAX_ADJUSTMENT,
            maxTime = photos[photos.length - 1].time + MAX_ADJUSTMENT;
            
        var timeline = d3.select("#timeline").attr('viewBox', "0 0 1000 100").attr('preserveAspectRatio', "none"),
            timelineAltitudes = timeline.append('svg:g'),
            timelineMarkers = timeline.append('svg:g');
        
        var timeScaleX = d3.scale.linear().domain([minTime, maxTime]).range([0, 1000]),
            timeScaleY = d3.scale.log().domain([500, 12500]).range([100, 0]);
        timelineMarkers = timelineMarkers.selectAll('.photo').data(photos)
        timelineMarkers.enter().append('svg:circle').classed('photo', true).attr('r', 3).attr('cx', function (d) { return timeScaleX(d.time); }).attr('cy', 50);
        
        var po = org.polymaps,
            map = po.map().container(d3.select('#map').append("svg:svg").node());
        //map.add(po.interact());
        map.add(po.image()
            .url(po.url("http://{S}tile.cloudmade.com"
            + "/51664f123b50414da85e963f92c721f0"
            + "/998/256/{Z}/{X}/{Y}.png")
            .hosts(["a.", "b.", "c.", ""])));
        
        var coordDB = fermata.json(location_db),
            coordsIndexed = coordDB(["_design/loclog", "_view"]);
        //coordsIndexed('by_utc', {reduce:false, $startkey:dateAsArrayUTC(minTime), $endkey:dateAsArrayUTC(maxTime)}).get(function (e,d) {
            //var coords = d.rows.map(function (p) { p = p.value; return [p.lon, p.lat, p.ele, Date.parse(p.time)]; }),
        //coordsIndexed('by_time', {reduce:false, $startkey:dateAsArrayUTC(minTime), $endkey:dateAsArrayUTC(maxTime)}).get(function (e,d) {
            //var coords = d.rows.map(function (r) { var c = r.value; c[3] = dateFromArrayUTC(r.key).getTime(); return c; }),
        coordsIndexed(['../_list', 'compact/by_time'], {reduce:false, $startkey:dateAsArrayUTC(minTime), $endkey:dateAsArrayUTC(maxTime)}).get(function (e,d) {
            var coords = d.map(function (c) { c[3] = dateFromArrayUTC(c[3]).getTime(); return c; }),
                coordTimes = coords.map(function (c) { return c[3]; });
            
            timelineAltitudes = timelineAltitudes.selectAll('.coord').data(coords);
            timelineAltitudes.enter().append('svg:circle').classed('coord', true).attr('r',1)
                .attr('cx', function (d) { return timeScaleX(d[3]); })
                .attr('cy', function (d) { return timeScaleY(d[2]+500); });
            console.log("Rendering", coords.length, "coordinates");
        });
        
        //coordsIndexed('by_utc', {reduce:false, limit:24*60*60}).get(function (e,d) {});
        //coordsIndexed('by_time', {reduce:false, limit:24*60*60}).get(function (e,d) {});
        //coordsIndexed(['../_list', 'compact', 'by_time'], {reduce:false, limit:24*60*60}).get(function (e,d) { console.log(d.length); });
        
    </script>
</body>
</html>
